<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Punch Gacha: All-in-One</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff4757; --dark: #0a0a0a; --green: #2ecc71; --purple: #a020f0; --blue: #3498db; --orange: #e67e22; }
        body { margin: 0; background: var(--dark); color: #fff; font-family: 'Poppins', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #videoBg { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; filter: brightness(0.2); pointer-events: none; }
        .screen { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; padding-bottom: 120px; z-index: 5; opacity: 0; transition: 0.3s; }
        .screen.active { display: flex; opacity: 1; }
        .btn { background: var(--red); color: #fff; border: none; padding: 12px; border-radius: 12px; font-family: 'Bebas Neue'; font-size: 1.1rem; width: 100%; cursor: pointer; box-shadow: 0 4px 0 #800; margin-bottom: 10px; }
        .rarity { position: absolute; top: 5px; right: 5px; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; font-family: 'Bebas Neue'; z-index: 5; }
        .LR { background: linear-gradient(45deg, #ff0000, #ffd700); box-shadow: 0 0 10px #f00; }
        .SSR { background: var(--gold); color: #000; }
        .card-item { position: relative; aspect-ratio: 2/3; border-radius: 12px; overflow: hidden; background-color: #222; background-size: cover; background-position: center; border: 1px solid #444; }
        .hp-container { width: 90%; height: 6px; background: #333; border-radius: 10px; margin: 5px auto; overflow: hidden; position: absolute; bottom: 5px; left: 5%; }
        .hp-bar { height: 100%; width: 100%; transition: width 0.4s ease; background: var(--green); }
        .fighter-box { height: 130px; border: 2px solid #444; border-radius: 15px; background-size: cover; background-position: center; position: relative; overflow: hidden; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; width: 100%; box-sizing: border-box; }
        .shop-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; width: 100%; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; border: 1px solid #333; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: rgba(10,10,10,0.98); display: flex; border-top: 1px solid #333; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 0.65rem; cursor: pointer; }
        .nav-item.active { color: var(--gold); }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }
        #vs-overlay, #result-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes gachaPop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .gacha-anim { animation: gachaPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(2px,2px); } 50% { transform: translate(-2px,-2px); } }
        .shake { animation: shake 0.2s infinite; }
    </style>
</head>
<body onclick="document.getElementById('videoBg').play()">

    <video id="videoBg" playsinline loop muted>
        <source src="https://raw.githubusercontent.com/mabarrra670-max/Sik/2618c2c289f712966754adcf30adcf30af376696ccc73f/lv_0_20260101162558.mp4" type="video/mp4">
    </video>

    <div style="padding: 10px 15px; background: rgba(0,0,0,0.85); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; z-index: 100;">
        <div id="p-name" style="color:var(--gold); font-weight: bold;">PLAYER</div>
        <div style="font-size: 0.85rem; display: flex; gap: 10px;">
            <span>游눑 <span id="p-dia">0</span></span>
            <span style="color:var(--orange)">游리 <span id="p-coin">0</span></span>
        </div>
    </div>

    <div id="gacha" class="screen active">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">SUMMON</h2>
        <div id="single-view" style="width:180px; height:260px; margin:20px 0; border:2px solid #444; border-radius:15px; background-size:cover; background-position:center; position:relative;">
            <div id="gacha-rarity" class="rarity"></div>
        </div>
        <button class="btn" onclick="window.pull()">PULL (100 游눑)</button>
    </div>

    <div id="pvp" class="screen">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">ARENA</h2>
        <button id="btn-match" class="btn" style="background:var(--orange);" onclick="window.startMatchmaking()">CARI LAWAN</button>
        <div id="arena-box" style="width:100%; margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="width:45%;"><div id="p-fighter" class="fighter-box"></div><small>YOU</small></div>
                <b style="color:red; font-size: 1.5rem;">VS</b>
                <div style="width:45%;"><div id="e-fighter" class="fighter-box"></div><small>ENEMY</small></div>
            </div>
        </div>
    </div>

    <div id="rank" class="screen"><h2 style="font-family:'Bebas Neue'; color:var(--gold);">RANKING</h2><div id="leaderboard-list" style="width:100%;"></div></div>
    <div id="market" class="screen"><h2 style="font-family:'Bebas Neue'; color:var(--gold);">MARKET</h2><p style="font-size:0.7rem; color:#888;">Jual Kartu = 10 游리</p><div id="market-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; width:100%;"></div></div>
    <div id="shop" class="screen"><h2 style="font-family:'Bebas Neue'; color:var(--gold);">SHOP</h2><div class="shop-card"><div><b>100 DIAMONDS</b><br><small>Harga: 50 游리</small></div><button class="btn" style="width:auto; padding:5px 15px; margin:0;" onclick="window.buyDia(100, 50)">BELI</button></div></div>
    
    <div id="profil" class="screen">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">PROFILE</h2>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; width:100%; text-align:center; border:1px solid var(--gold);">
            <h3 id="prof-name-val" style="margin:5px 0;">PLAYER</h3>
            <div style="font-size:0.8rem; color:#ccc;">Hero Aktif: <span id="prof-hero-val" style="color:var(--gold);">None</span></div>
        </div>
        <h4 style="margin: 15px 0 10px;">KOLEKSI</h4>
        <div id="inv-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; width:100%;"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="window.nav('gacha', this)"><span>游</span>Summon</div>
        <div class="nav-item" onclick="window.nav('pvp', this)"><span>丘덢잺</span>Arena</div>
        <div class="nav-item" onclick="window.nav('rank', this)"><span>游끥</span>Rank</div>
        <div class="nav-item" onclick="window.nav('market', this)"><span>丘뒲잺</span>Market</div>
        <div class="nav-item" onclick="window.nav('shop', this)"><span>游눑</span>Shop</div>
        <div class="nav-item" onclick="window.nav('profil', this)"><span>游녻</span>Hero</div>
    </nav>

    <div id="vs-overlay"><h1 style="font-family:'Bebas Neue'; color:var(--red);">BATTLE FOUND!</h1><div id="vs-timer" style="font-size:5rem; color:var(--gold);">3</div></div>
    <div id="result-screen"><h1 id="res-title" style="font-size:4rem; font-family:'Bebas Neue';"></h1><button class="btn" style="width:200px;" onclick="location.reload()">KEMBALI</button></div>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js";
        const socket = io("https://cahsaitama.onrender.com");
        const tg = window.Telegram.WebApp;
        tg.expand();

        const heroPool = [
            { id: 1, name: "Saitama God", rar: "LR", pwr: 999999, rate: 0.5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/saitamagod.png" },
            { id: 2, name: "God", rar: "LR", pwr: 850000, rate: 0.5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/god.png" },
            { id: 3, name: "Cosmic Garou", rar: "SSR", pwr: 95000, rate: 2, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/cosmicgarou.png" },
            { id: 4, name: "Blast", rar: "SSR", pwr: 90000, rate: 2, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/blast.png" },
            { id: 5, name: "Tatsumaki", rar: "SSR", pwr: 85000, rate: 2, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/tatsumaki.png" },
            { id: 6, name: "Saitama", rar: "SSR", pwr: 80000, rate: 3, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/saitama.png" },
            { id: 7, name: "Garou Monster", rar: "SR", pwr: 45000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/garoumonster.png" },
            { id: 8, name: "Bang", rar: "SR", pwr: 42000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/bang.png" },
            { id: 9, name: "Genos", rar: "SR", pwr: 38000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/genos.png" },
            { id: 10, name: "Atomic Samurai", rar: "SR", pwr: 35000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/atomicsamurai.png" },
            { id: 11, name: "Flashy Flash", rar: "SR", pwr: 33000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/flashyflash.png" },
            { id: 12, name: "Fubuki", rar: "SR", pwr: 30000, rate: 5, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/fubuki.png" },
            { id: 13, name: "Amai Mask", rar: "R", pwr: 15000, rate: 12, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/amaimask.png" },
            { id: 14, name: "Child Emperor", rar: "R", pwr: 12000, rate: 12, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/childemperor.png" },
            { id: 15, name: "Puri Puri Prisoner", rar: "R", pwr: 10000, rate: 12, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/puripuri.png" },
            { id: 16, name: "Mumen Rider", rar: "R", pwr: 5000, rate: 12, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/mumenrider.png" },
            { id: 17, name: "King", rar: "R", pwr: 1, rate: 12, img: "https://raw.githubusercontent.com/mabarrra670-max/Gacha/0accb245d41298fdcf5a0481fc990c4b352ae326/card/king.png" }
        ];

        let db = JSON.parse(localStorage.getItem('OPG_DATA')) || { 
            name: tg.initDataUnsafe?.user?.first_name || "HERO", 
            dia: 500, coin: 0, inv: [], selected: null, lastClaim: "" 
        };

        // DAILY REWARD LOGIC
        const today = new Date().toDateString();
        if (db.lastClaim !== today) {
            db.dia += 50;
            db.lastClaim = today;
            tg.showAlert("Daily Reward! Kamu mendapatkan 游눑 50 hari ini.");
        }

        window.save = () => {
            localStorage.setItem('OPG_DATA', JSON.stringify(db));
            document.getElementById('p-dia').innerText = db.dia;
            document.getElementById('p-coin').innerText = db.coin;
            document.getElementById('p-name').innerText = db.name;
            document.getElementById('prof-name-val').innerText = db.name;
            document.getElementById('prof-hero-val').innerText = db.selected ? db.selected.name : "None";
            socket.emit("update_my_status", { 
                name: db.name, hero: db.selected ? db.selected.name : "None", 
                pwr: db.selected ? db.selected.pwr * (db.selected.lvl || 1) : 0, coins: db.coin 
            });
        };

        window.nav = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'profil') updateInventory();
            if(id === 'market') updateMarket();
            if(id === 'rank') socket.emit("get_leaderboard");
        };

        window.pull = () => {
    if(db.dia < 100) return tg.showAlert("Diamond Kurang!");
    db.dia -= 100;

    const totalRate = heroPool.reduce((a,b)=>a+b.rate,0);
    let r = Math.random() * totalRate;
    let cur = 0;
    let rolled = heroPool[heroPool.length-1];

    for(let h of heroPool){
        cur += h.rate;
        if(r <= cur){
            rolled = h;
            break;
        }
    }

    let o = db.inv.find(x => x.id === rolled.id);
    if(o) o.lvl = (o.lvl || 1) + 1;
    else db.inv.push({...rolled, lvl:1});

    const view = document.getElementById('single-view');
    view.classList.remove('gacha-anim');

    setTimeout(() => {
        view.style.backgroundImage = `url('${rolled.img}')`;
        view.classList.add('gacha-anim');
        document.getElementById('gacha-rarity').innerText = rolled.rar;
        document.getElementById('gacha-rarity').className = `rarity ${rolled.rar}`;
        window.save();
    }, 50);
};
        function updateInventory() {
            document.getElementById('inv-grid').innerHTML = db.inv.map(h => `
                <div class="card-item" style="background-image:url('${h.img}')" onclick="window.selectHero(${h.id})">
                    <div class="rarity ${h.rar}">${h.rar}</div>
                    <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); font-size:0.6rem; text-align:center;">LVL ${h.lvl || 1}</div>
                </div>`).join('');
        }

        window.selectHero = (id) => {
            db.selected = db.inv.find(x => x.id === id);
            document.getElementById('p-fighter').style.backgroundImage = `url('${db.selected.img}')`;
            tg.showConfirm("Gunakan " + db.selected.name + "?", (ok) => { if(ok) window.save(); });
        };

        window.startMatchmaking = () => {
            if(!db.selected) return tg.showAlert("Pilih Hero di Profile!");
            socket.emit("find_match", { name: db.name, img: db.selected.img, pwr: db.selected.pwr * (db.selected.lvl || 1) });
            document.getElementById('btn-match').innerText = "MENCARI...";
        };

        socket.on("match_found", (data) => {
            document.getElementById('vs-overlay').style.display = 'flex';
            let c = 3;
            let t = setInterval(() => {
                c--; document.getElementById('vs-timer').innerText = c;
                if(c<=0){ clearInterval(t); document.getElementById('vs-overlay').style.display='none'; startFight(data.opponent); }
            }, 1000);
        });

        function startFight(opp) {
            // Reset Arena Visuals
            document.getElementById('p-fighter').innerHTML = '';
            document.getElementById('e-fighter').innerHTML = '';
            document.getElementById('e-fighter').style.backgroundImage = `url('${opp.img}')`;
            document.getElementById('p-fighter').innerHTML = '<div class="hp-container"><div id="hp1" class="hp-bar"></div></div>';
            document.getElementById('e-fighter').innerHTML = '<div class="hp-container"><div id="hp2" class="hp-bar" style="background:red"></div></div>';
            
            let s = 0;
            const myBase = db.selected.pwr * (db.selected.lvl || 1);
            const myPwr = myBase * (0.9 + Math.random() * 0.2); 
            const oppPwr = opp.pwr * (0.9 + Math.random() * 0.2);

            let i = setInterval(() => {
                s++; 
                document.getElementById('arena-box').classList.add('shake');
                tg.HapticFeedback.impactOccurred('heavy');
                setTimeout(() => document.getElementById('arena-box').classList.remove('shake'), 100);
                
                if(myPwr > oppPwr) {
                    document.getElementById('hp2').style.width = (100 - (s*20))+"%";
                    document.getElementById('hp1').style.width = "100%";
                } else {
                    document.getElementById('hp1').style.width = (100 - (s*20))+"%";
                    document.getElementById('hp2').style.width = "100%";
                }
                
                if(s>=5){ 
                    clearInterval(i); 
                    showRes(myPwr > oppPwr); 
                    document.getElementById('btn-match').innerText = "CARI LAWAN";
                }
            }, 600);
        }

        function showRes(win) {
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('res-title').innerText = win ? "VICTORY" : "DEFEAT";
            document.getElementById('res-title').style.color = win ? "var(--gold)" : "var(--red)";
            if(win) tg.HapticFeedback.notificationOccurred('success');
        }

        function updateMarket() {
            document.getElementById('market-grid').innerHTML = db.inv.map(h => `
                <div class="card-item" style="background-image:url('${h.img}')">
                    <button onclick="window.sellHero(${h.id})" style="position:absolute; bottom:0; width:100%; background:red; color:white; border:none; font-size:0.6rem; padding:5px;">JUAL (10游리)</button>
                </div>`).join('');
        }

        window.sellHero = (id) => {
            const idx = db.inv.findIndex(x => x.id === id);
            if(idx > -1) {
                if(db.selected && db.selected.id === id) db.selected = null;
                db.inv.splice(idx, 1);
                db.coin += 10;
                window.save(); updateMarket();
            }
        };

        window.buyDia = (a, p) => {
            if(db.coin < p) return tg.showAlert("Koin tidak cukup!");
            db.coin -= p; db.dia += a; window.save(); tg.showAlert("Berhasil beli!");
        };

        socket.on("leaderboard_data", (data) => {
            document.getElementById('leaderboard-list').innerHTML = data.map((p, i) => `
                <div class="rank-item">
                    <span>#${i+1} ${p.name}</span>
                    <span style="color:var(--gold)">${p.pwr.toLocaleString()} PWR</span>
                </div>`).join('');
        });

        window.save();
    </script>
</body>
    </html>
