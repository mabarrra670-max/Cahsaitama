<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Punch Gacha: Online PvP</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff4757; --dark: #0a0a0a; --green: #2ecc71; --purple: #a020f0; --blue: #3498db; --orange: #e67e22; --silver: #bdc3c7; }
        body { margin: 0; background: var(--dark); color: #fff; font-family: 'Poppins', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #videoBg { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; filter: brightness(0.2); pointer-events: none; }
        
        .screen { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; padding-bottom: 120px; z-index: 5; opacity: 0; transform: translateY(15px); transition: 0.4s ease; }
        .screen.active { display: flex; opacity: 1; transform: translateY(0); }

        /* SHOP & MARKET STYLE */
        .shop-card { background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 15px; padding: 15px; width: 100%; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .coin-text { color: var(--orange); font-weight: bold; }
        
        /* PROFILE STYLE */
        .profile-header { background: linear-gradient(135deg, #222, #111); width: 100%; padding: 20px; border-radius: 20px; border: 1px solid var(--gold); text-align: center; box-sizing: border-box; }
        .stat-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 20px; }
        .stat-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #333; }

        /* STANDAR UI */
        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(10,10,10,0.95); display: flex; border-top: 1px solid #333; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 0.6rem; cursor: pointer; }
        .nav-item.active { color: var(--gold); }
        .nav-item span { font-size: 1.2rem; }
        .btn { background: var(--red); color: #fff; border: none; padding: 10px; border-radius: 10px; font-family: 'Bebas Neue'; cursor: pointer; }
        .btn-sm { padding: 5px 15px; font-size: 0.8rem; }
        
        .rarity { position: absolute; top: 5px; right: 5px; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.6rem; font-family: 'Bebas Neue'; }
        .LR { background: linear-gradient(45deg, #f00, #ff0); color: #fff; }
        .SSR { background: var(--gold); color: #000; }
        .card-item { position: relative; aspect-ratio: 2/3; border-radius: 10px; overflow: hidden; background-size: cover; background-position: center; border: 1px solid #444; }
    </style>
</head>
<body onclick="document.getElementById('videoBg').play()">

    <video id="videoBg" playsinline loop muted>
        <source src="https://raw.githubusercontent.com/mabarrra670-max/Sik/2618c2c289f712966754adcf30adcf30af376696ccc73f/lv_0_20260101162558.mp4" type="video/mp4">
    </video>

    <div style="padding: 10px 20px; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; z-index:100;">
        <div id="p-name" style="color:var(--gold); font-weight:bold;">PLAYER</div>
        <div style="display:flex; gap:15px; font-size: 0.8rem;">
            <span>üíé <span id="p-dia">0</span></span>
            <span style="color:var(--orange);">üü° <span id="p-coin">0</span></span>
        </div>
    </div>

    <div id="gacha" class="screen active">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">SUMMON HERO</h2>
        <div id="single-view" style="width:180px; height:260px; margin:10px 0; border:2px solid #444; border-radius:15px; background-size:cover; background-position:center; position:relative;">
            <div id="gacha-rarity" class="rarity"></div>
        </div>
        <button class="btn" style="width:200px" onclick="window.pull()">PULL (100 üíé)</button>
    </div>

    <div id="market" class="screen">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">MARKETPLACE</h2>
        <p style="font-size:0.7rem; color:#888;">Jual kartu duplikat untuk mendapatkan 10 Coins</p>
        <div id="market-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; width:100%;"></div>
    </div>

    <div id="shop" class="screen">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">COIN SHOP</h2>
        <div class="shop-card">
            <div><b>100 DIAMONDS</b><br><span class="coin-text">Price: 50 Coins</span></div>
            <button class="btn btn-sm" style="background:var(--green)" onclick="window.buyDia(100, 50)">BUY</button>
        </div>
        <div class="shop-card">
            <div><b>500 DIAMONDS</b><br><span class="coin-text">Price: 200 Coins</span></div>
            <button class="btn btn-sm" style="background:var(--green)" onclick="window.buyDia(500, 200)">BUY</button>
        </div>
    </div>

    <div id="profil" class="screen">
        <div class="profile-header">
            <div style="width:60px; height:60px; background:var(--gold); border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:2rem;">üë§</div>
            <h2 id="prof-name" style="margin:0; font-family:'Bebas Neue';">PLAYER</h2>
            <span id="prof-id" style="font-size:0.7rem; color:#888;">ID: GUEST</span>
        </div>
        <div class="stat-box">
            <div class="stat-item"><small>TOTAL HERO</small><br><b id="stat-count" style="color:var(--gold)">0</b></div>
            <div class="stat-item"><small>COINS</small><br><b id="stat-coin" style="color:var(--orange)">0</b></div>
        </div>
        <div id="selected-hero-box" style="margin-top:20px; width:100%; background:rgba(255,215,0,0.1); padding:15px; border-radius:15px; border:1px solid var(--gold); text-align:center;">
            <small>SELECTED FOR BATTLE:</small><br>
            <b id="prof-hero-name">None</b>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="window.nav('gacha', this)"><span>üõí</span>Summon</div>
        <div class="nav-item" onclick="window.nav('market', this)"><span>‚öñÔ∏è</span>Market</div>
        <div class="nav-item" onclick="window.nav('shop', this)"><span>üíé</span>Shop</div>
        <div class="nav-item" onclick="window.nav('profil', this)"><span>üë§</span>Profile</div>
    </nav>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js";
        const socket = io("https://cahsaitama.onrender.com");
        const tg = window.Telegram.WebApp;

        const heroPool = [
            { id:1, name:"Saitama God", rar:"LR", pwr:999999, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/saitamagod.png", rate:1 },
            { id:2, name:"Cosmic Garou", rar:"LR", pwr:65000, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/cosmicgarou.png", rate:5 },
            { id:3, name:"Saitama", rar:"SSR", pwr:50000, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/saitama.png", rate:10 }
        ];

        let db = JSON.parse(localStorage.getItem('OPG_DATA')) || { name:"PLAYER", dia:1000, coin:0, inv:[], selected:null };
        
        window.save = () => {
            localStorage.setItem('OPG_DATA', JSON.stringify(db));
            document.getElementById('p-dia').innerText = db.dia;
            document.getElementById('p-coin').innerText = db.coin;
            document.getElementById('p-name').innerText = db.name;
            // Sinkron ke Profile
            document.getElementById('prof-name').innerText = db.name;
            document.getElementById('stat-count').innerText = db.inv.length;
            document.getElementById('stat-coin').innerText = db.coin;
            document.getElementById('prof-hero-name').innerText = db.selected ? db.selected.name : "None";
            
            socket.emit("update_my_status", { 
                name: db.name, 
                hero: db.selected ? db.selected.name : "None", 
                pwr: db.selected ? db.selected.pwr * db.selected.lvl : 0,
                coins: db.coin
            });
        };

        window.nav = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'market') updateMarket();
            window.save();
        };

        window.pull = () => {
            if(db.dia < 100) return alert("Diamond kurang!");
            db.dia -= 100;
            let r = Math.random()*100, cur=0, rolled;
            for(let h of heroPool){ cur+=h.rate; if(r<=cur){rolled=h; break;} }
            if(!rolled) rolled = heroPool[heroPool.length-1];
            
            let o = db.inv.find(x => x.id === rolled.id);
            if(o) o.lvl++; else db.inv.push({...rolled, lvl:1});
            
            const view = document.getElementById('single-view');
            view.style.backgroundImage = `url('${rolled.img}')`;
            document.getElementById('gacha-rarity').innerText = rolled.rar;
            document.getElementById('gacha-rarity').className = `rarity ${rolled.rar}`;
            window.save();
        };

        // MARKET LOGIC
        function updateMarket() {
            document.getElementById('market-grid').innerHTML = db.inv.map(h => `
                <div class="card-item" style="background-image:url('${h.img}')">
                    <div class="rarity ${h.rar}">LVL ${h.lvl}</div>
                    <button onclick="window.sellHero(${h.id})" style="position:absolute; bottom:0; width:100%; border:none; background:rgba(255,71,87,0.9); color:white; font-size:0.6rem; padding:4px; cursor:pointer;">SELL (10üü°)</button>
                </div>`).join('');
        }

        window.sellHero = (id) => {
            const index = db.inv.findIndex(x => x.id === id);
            if(index > -1) {
                if(db.selected && db.selected.id === id) db.selected = null;
                db.inv.splice(index, 1);
                db.coin += 10;
                tg.HapticFeedback.notificationOccurred('success');
                updateMarket();
                window.save();
            }
        };

        // SHOP LOGIC
        window.buyDia = (amount, price) => {
            if(db.coin < price) return alert("Coins tidak cukup!");
            db.coin -= price;
            db.dia += amount;
            tg.HapticFeedback.notificationOccurred('success');
            alert("Berhasil membeli " + amount + " Diamonds!");
            window.save();
        };

        if (tg.initDataUnsafe?.user) {
            db.name = tg.initDataUnsafe.user.first_name.toUpperCase();
            document.getElementById('prof-id').innerText = "ID: " + tg.initDataUnsafe.user.id;
        }
        window.save();
    </script>
</body>
            </html>
