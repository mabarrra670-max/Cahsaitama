<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One Punch Gacha: Online PvP</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff4757; --dark: #0a0a0a; --green: #2ecc71; --purple: #a020f0; --blue: #3498db; --orange: #e67e22; }
        body { margin: 0; background: var(--dark); color: #fff; font-family: 'Poppins', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #videoBg { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; filter: brightness(0.25); pointer-events: none; }
        #flash-effect { position: fixed; inset: 0; background: white; opacity: 0; z-index: 10000; pointer-events: none; transition: 0.2s; }

        .screen { 
            flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; 
            overflow-y: auto; padding-bottom: 120px; z-index: 5;
            opacity: 0; transform: translateY(15px); transition: 0.4s ease;
        }
        .screen.active { display: flex; opacity: 1; transform: translateY(0); }

        /* RARITY & TYPE BADGE */
        .rarity { position: absolute; top: 5px; right: 5px; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; font-family: 'Bebas Neue'; z-index: 5; }
        .LR { background: linear-gradient(45deg, #ff0000, #ffd700); color: #fff; box-shadow: 0 0 15px #f00; animation: glow-lr 1s infinite alternate; }
        .SSR { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); }
        .SR { background: var(--purple); color: #fff; }
        .R { background: var(--blue); color: #fff; }

        .type-badge { position: absolute; top: 5px; left: 5px; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; z-index: 5; border: 1px solid rgba(255,255,255,0.6); }
        .type-FIST { background: #e74c3c; }
        .type-ESPER { background: #9b59b6; }
        .type-TECH { background: #3498db; }
        .type-BLADE { background: #f1c40f; color: #000; }
        
        @keyframes glow-lr { from { box-shadow: 0 0 10px #f00; } to { box-shadow: 0 0 25px #ff0; } }

        .card-item { position: relative; aspect-ratio: 2/3; border: 1px solid rgba(255,215,0,0.3); border-radius: 12px; overflow: hidden; background-color: #222; background-size: cover; background-position: center; }
        .pwr-tag { position: absolute; bottom: 45px; width: 100%; background: rgba(0,0,0,0.85); color: var(--gold); font-size: 0.65rem; text-align: center; font-weight: 600; padding: 2px 0; }
        .up-btn { width: 100%; background: var(--green); border: none; color: #fff; font-size: 0.7rem; padding: 5px 0; font-family: 'Bebas Neue'; cursor: pointer; position: absolute; bottom: 0; }

        .fighter-box { height: 140px; border: 2px solid #444; border-radius: 15px; background-size: cover; background-position: center; background-color: #111; position: relative; }
        
        /* NAVBAR */
        .nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: rgba(10,10,10,0.95); display: flex; border-top: 1px solid #333; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--gold); }
        .nav-item span { font-size: 1.5rem; margin-bottom: 4px; }

        .btn { background: var(--red); color: #fff; border: none; padding: 12px; border-radius: 12px; font-family: 'Bebas Neue'; font-size: 1.1rem; cursor: pointer; width: 100%; box-shadow: 0 4px 0 #800; margin-bottom: 5px; }
        
        /* LOADING & VS SCREEN */
        .loader { border: 5px solid #333; border-top: 5px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #vs-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        .vs-card { width: 120px; height: 180px; border: 3px solid var(--gold); border-radius: 10px; background-size: cover; background-position: center; transition: 0.5s ease-out; }

        #login-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body onclick="window.initAudio()">

    <div id="flash-effect"></div>
    <audio id="sfx-match" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <div id="login-screen">
        <h1 style="font-family:'Bebas Neue'; color:var(--gold); font-size:3rem;">ONE PUNCH GACHA</h1>
        <p>Buka Game melalui Bot Telegram</p>
    </div>

    <div id="vs-overlay">
        <h2 style="font-family:'Bebas Neue'; color:var(--red); font-size:3rem;">BATTLE FOUND!</h2>
        <div style="display:flex; align-items:center; gap:20px; margin: 20px 0;">
            <div id="vs-p1" class="vs-card" style="transform: translateX(-100px); opacity: 0;"></div>
            <b style="font-size:2rem; color:white;">VS</b>
            <div id="vs-p2" class="vs-card" style="transform: translateX(100px); opacity: 0;"></div>
        </div>
        <h1 id="vs-timer" style="font-family:'Bebas Neue'; font-size:4rem; color:var(--gold);">3</h1>
    </div>

    <video id="videoBg" playsinline loop muted>
        <source src="https://raw.githubusercontent.com/mabarrra670-max/Sik/2618c2c289f712966754adcf30adcf30af376696ccc73f/lv_0_20260101162558.mp4" type="video/mp4">
    </video>

    <div class="header" style="padding: 15px; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center;">
        <div>
            <b id="p-name" style="color:var(--gold);">PLAYER</b><br>
            <span id="p-id" style="font-size:0.6rem; color:#888;">ID: ...</span>
        </div>
        <div style="background:rgba(255,215,0,0.1); padding:5px 15px; border-radius:20px; border:1px solid var(--gold); color:var(--gold);">üíé <span id="p-dia">0</span></div>
    </div>

    <div id="gacha" class="screen active">
        <h2 style="font-family:'Bebas Neue'; color:var(--gold);">SUMMON HERO</h2>
        <div id="single-view" style="width:200px; height:280px; margin:20px 0; border:2px solid #444; border-radius:15px; background-size:cover; background-position:center; position:relative;">
            <div id="gacha-rarity" class="rarity"></div>
        </div>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn" onclick="window.pull(1)">1x PULL</button>
            <button class="btn" style="background:var(--orange);" onclick="window.pull(10)">10x PULL</button>
        </div>
    </div>

    <div id="pvp" class="screen">
        <h3 style="font-family:'Bebas Neue'; color:var(--gold);">BATTLE ARENA</h3>
        <button id="btn-match" class="btn" style="background:var(--orange);" onclick="window.startMatchmaking()">FIND ONLINE OPPONENT</button>
        
        <div id="loading-box" style="display:none; flex-direction:column; align-items:center; margin:10px;">
            <div class="loader"></div>
            <small id="online-status">Searching opponent...</small>
        </div>

        <div style="width:100%; background:rgba(0,0,0,0.6); padding:15px; border-radius:15px; margin-top:10px; border:1px solid #333;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="width:45%; text-align:center;">
                    <div id="p-fighter" class="fighter-box"></div>
                    <small id="p-pwr-val" style="color:var(--gold);">PWR: 0</small>
                </div>
                <b style="color:red;">VS</b>
                <div style="width:45%; text-align:center;">
                    <div id="e-fighter" class="fighter-box"></div>
                    <small id="e-pwr-val" style="color:var(--gold);">PWR: ???</small>
                </div>
            </div>
        </div>
        <p style="font-size: 0.7rem; color: #888; margin-top: 10px;">Pilih hero di menu "Hero" sebelum bertarung.</p>
    </div>

    <div id="profil" class="screen">
        <h3 style="font-family:'Bebas Neue'; color:var(--gold);">MY COLLECTION</h3>
        <div id="inv-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; width:100%;"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="window.nav('gacha', this)"><span>üõí</span>Summon</div>
        <div class="nav-item" onclick="window.nav('pvp', this)"><span>‚öîÔ∏è</span>Arena</div>
        <div class="nav-item" onclick="window.nav('profil', this)"><span>üë§</span>Hero</div>
    </nav>

    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js";

        // CONFIG SERVER RENDER
        const socket = io("https://cahsaitama.onrender.com");

        const heroPool = [
            { id:1, name:"Saitama God", rar:"LR", type:"FIST", rate:1, pwr:999999, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/saitamagod.png" },
            { id:2, name:"Cosmic Garou", rar:"LR", type:"FIST", rate:5, pwr:65000, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/cosmicgarou.png" },
            { id:3, name:"Saitama", rar:"SSR", type:"FIST", rate:10, pwr:50000, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/saitama.png" },
            { id:13, name:"Mumen Rider", rar:"R", type:"FIST", rate:84, pwr:1000, img:"https://raw.githubusercontent.com/mabarrra670-max/Gacha/2b743c1c0667b9d0c68148690f832ad239da9d59/card/mumenrider.png" }
        ];

        let db = JSON.parse(localStorage.getItem('OPG_DATA')) || { 
            name:"PLAYER", id: "GUEST", dia:5000, inv:[], selected:null, pity:0 
        };

        // TELEGRAM AUTH
        const tg = window.Telegram.WebApp;
        if (tg.initDataUnsafe?.user) {
            db.name = (tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name).toUpperCase();
            db.id = "TG-" + tg.initDataUnsafe.user.id;
            document.getElementById('login-screen').style.display = 'none';
        }

        window.save = () => {
            localStorage.setItem('OPG_DATA', JSON.stringify(db));
            document.getElementById('p-dia').innerText = db.dia.toLocaleString();
            document.getElementById('p-name').innerText = db.name;
            document.getElementById('p-id').innerText = "ID: " + db.id;
        };

        window.nav = (id, el) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) el.classList.add('active');
            if(id === 'profil') updateInventory();
        };

        window.pull = (t) => {
            if(db.dia < t*100) return alert("Diamond Kurang!");
            db.dia -= t*100;
            let rolled;
            for(let i=0; i<t; i++) {
                let r = Math.random()*100, cur=0;
                for(let h of heroPool){ cur+=h.rate; if(r<=cur){rolled=h; break;} }
                if(!rolled) rolled = heroPool[heroPool.length-1];
                let o = db.inv.find(x => x.id === rolled.id);
                if(o) o.lvl++; else db.inv.push({...rolled, lvl:1});
            }
            document.getElementById('single-view').style.backgroundImage = `url('${rolled.img}')`;
            document.getElementById('gacha-rarity').innerText = rolled.rar;
            document.getElementById('gacha-rarity').className = `rarity ${rolled.rar}`;
            window.save();
        };

        function updateInventory() {
            document.getElementById('inv-grid').innerHTML = db.inv.map(h => `
                <div class="card-item" style="background-image:url('${h.img}')" onclick="window.selectHero(${h.id})">
                    <div class="rarity ${h.rar}">${h.rar}</div>
                    <div class="pwr-tag">LVL ${h.lvl}</div>
                </div>`).join('');
        }

        window.selectHero = (id) => {
            db.selected = db.inv.find(x => x.id === id);
            alert("Hero selected for battle!");
            document.getElementById('p-fighter').style.backgroundImage = `url('${db.selected.img}')`;
            document.getElementById('p-pwr-val').innerText = "PWR: " + (db.selected.pwr * db.selected.lvl).toLocaleString();
        };

        // --- MULTIPLAYER LOGIC ---
        window.startMatchmaking = () => {
            if(!db.selected) return alert("Pilih hero dulu di menu Hero!");
            document.getElementById('loading-box').style.display = 'flex';
            document.getElementById('btn-match').style.display = 'none';

            socket.emit("find_match", {
                name: db.name,
                img: db.selected.img,
                pwr: db.selected.pwr * db.selected.lvl
            });
        };

        socket.on("match_found", (data) => {
            document.getElementById('sfx-match').play();
            const vs = document.getElementById('vs-overlay');
            const p1 = document.getElementById('vs-p1');
            const p2 = document.getElementById('vs-p2');
            
            vs.style.display = 'flex';
            p1.style.backgroundImage = `url('${db.selected.img}')`;
            p2.style.backgroundImage = `url('${data.opponent.img}')`;

            setTimeout(() => {
                p1.style.transform = "translateX(0)"; p1.style.opacity = "1";
                p2.style.transform = "translateX(0)"; p2.style.opacity = "1";
            }, 100);

            let count = 3;
            let timer = setInterval(() => {
                count--;
                document.getElementById('vs-timer').innerText = count;
                if(count <= 0) {
                    clearInterval(timer);
                    vs.style.display = 'none';
                    document.getElementById('loading-box').style.display = 'none';
                    document.getElementById('btn-match').style.display = 'block';
                    // Tampilkan data lawan di Arena
                    document.getElementById('e-fighter').style.backgroundImage = `url('${data.opponent.img}')`;
                    document.getElementById('e-pwr-val').innerText = "PWR: " + data.opponent.pwr.toLocaleString();
                    alert("Battle Starts! (Logic Realtime Battle akan ditambahkan selanjutnya)");
                }
            }, 1000);
        });

        window.initAudio = () => { document.getElementById('videoBg').muted = false; document.getElementById('videoBg').play(); };
        window.save();
    </script>
</body>
                    </html>
